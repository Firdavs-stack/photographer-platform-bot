const TOKEN =
	process.env.TELEGRAM_TOKEN ||
	"7647751844:AAGSToi5DCbuRGAA156G52obCl3FLHBn5j4";

const TelegramBot = require("node-telegram-bot-api");
const Calendar = require("telegram-inline-calendar");
process.env.NTBA_FIX_319 = 1;
const mongoose = require("mongoose");
const clientController = require("./controllers/clientController");
const photographerController = require("./controllers/photographerController");
const callbackHandler = require("./controllers/callbackHandler");
const stateController = require("./controllers/stateController");
const Client = require("./models/client");
const Photographer = require("./models/Photographer");
const Booking = require("./models/booking");

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new TelegramBot(TOKEN, {
	polling: true,
});

const calendar = new Calendar(bot, {
	date_format: "YYYY-MM-DD",
	language: "ru",
});

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
mongoose.connect(
	"mongodb+srv://firdavsusmanov418:gPPbpsmhIDE5sf9b@cluster0.owmnn.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0",
	{
		useNewUrlParser: true,
		useUnifiedTopology: true,
	}
);

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤
bot.on("message", async (msg) => {
	bot.sendMessage(chatId, calendar);
	const chatId = msg.chat.id;
	const client = await clientController.getClientByTelegramId(chatId);
	const state = await stateController.getState(chatId);
	const photographer =
		await photographerController.getPhotographerByTelegramId(chatId);

	if (
		msg.photo ||
		msg.document ||
		msg.video ||
		msg.audio ||
		(msg.text && msg.text.startsWith("/"))
	) {
		return;
	}

	if (client) {
		if (msg.text === "üîç –ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤") {
			// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º inline_keyboard —Å Web App –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤
			bot.sendMessage(
				chatId,
				"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤:",
				{
					reply_markup: {
						inline_keyboard: [
							[
								{
									text: "üîç –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤",
									web_app: {
										url: "https://two2one.uz",
									},
								},
							],
						],
					},
				}
			);
		} else {
			clientController.handleClientMessage(bot, msg, client);
		}
	} else if (photographer) {
		photographerController.handlePhotographerMessage(
			bot,
			msg,
			photographer
		);
	} else {
		if (state && state.state === "registering") {
			switch (state.step) {
				case "get_name":
					// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∞–º–∏–ª–∏—é –ø–æ—Å–ª–µ –∏–º–µ–Ω–∏
					await stateController.setState(chatId, {
						state: "registering",
						step: "get_phone",
						name: msg.text.trim(),
						referringPhotographerId: state.referringPhotographerId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞
					});
					bot.sendMessage(
						chatId,
						"–¢–µ–ø–µ—Ä—å, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ: +123456789):"
					);
					break;
				case "get_phone":
					// –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–µ–ª—å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
					const phone = msg.text.trim();
					if (!/^[+]\d{9,15}$/.test(phone)) {
						bot.sendMessage(
							chatId,
							"–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
						);
						return;
					}
					const newClient = new Client({
						telegramId: chatId.toString(),
						name: state.name,
						phone: phone,
						telegramUsername: msg.from.username,
						referringPhotographerId: state.referringPhotographerId, // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞
					});
					await newClient.save();

					// –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
					await stateController.clearState(chatId);

					bot.sendMessage(
						chatId,
						`–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${state.name}!`,
						{
							reply_markup: {
								keyboard: [
									["üîç –ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤"],
									["üë§ –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç", "üìÖ –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"],
									["‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã"],
								],
								one_time_keyboard: false,
								resize_keyboard: true,
							},
						}
					);
					break;
				default:
					bot.sendMessage(
						chatId,
						"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É."
					);
					break;
			}
		} else {
			await stateController.setState(chatId, {
				state: "registering",
				step: "get_name",
			});
			bot.sendMessage(
				chatId,
				"–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ—Å—å. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:"
			);
		}
	}
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
bot.on("photo", async (msg) => {
	const chatId = msg.chat.id;
	const state = await stateController.getState(chatId);
	const photoId = msg.photo[msg.photo.length - 1].file_id;

	// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ
	const client = await Client.findOne({ telegramId: chatId.toString() });
	const photographer = await Photographer.findOne({
		telegramId: chatId.toString(),
	});

	try {
		if (client) {
			await handleClientPhoto(msg, state, client, photoId);
		} else if (photographer) {
			await handlePhotographerPhoto(msg, state, photographer, photoId);
		} else {
			// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
			bot.sendMessage(
				chatId,
				"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—É /start."
			);
		}
	} catch (error) {
		console.error("Error handling photo:", error);
		bot.sendMessage(chatId, `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`);
	}
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
async function handleClientPhoto(msg, state, client, photoId) {
	const chatId = msg.chat.id;

	if (!state) {
		return bot.sendMessage(
			chatId,
			"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞."
		);
	}

	switch (state.state) {
		case "awaiting_payment":
			await processPaymentScreenshot(state, photoId, chatId, client);
			break;
		case "cancellingBooking":
			await processCancellationScreenshot(state, photoId, chatId, client);
			break;
		default:
			bot.sendMessage(chatId, "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
	}
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –æ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞
async function handlePhotographerPhoto(msg, state, photographer, photoId) {
	const chatId = msg.chat.id;

	if (!state) {
		return bot.sendMessage(
			chatId,
			"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ."
		);
	}

	switch (state.state) {
		case "awaiting_portfolio_photos":
			await addPortfolioPhoto(state, photoId, chatId);
			break;
		case "cancellingBooking":
			await processCancellationScreenshot(
				state,
				photoId,
				chatId,
				photographer
			);
			break;
		default:
			bot.sendMessage(chatId, "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
	}
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –æ–ø–ª–∞—Ç—ã
async function processPaymentScreenshot(state, photoId, chatId, client) {
	const bookingId = state.bookingInfo._id;
	const booking = await Booking.findById(bookingId);

	if (!booking) {
		return bot.sendMessage(
			chatId,
			"–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
		);
	}

	booking.paymentScreenshot = photoId;
	booking.status = "awaiting_confirmation";
	await booking.save();

	// –£–≤–µ–¥–æ–º–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞
	const photographer = await Photographer.findById(booking.photographerId);
	if (photographer) {
		await bot.sendPhoto(photographer.telegramId, photoId, {
			caption: `–ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ *${client.name}* –Ω–∞ *${booking.date}* –≤ *${booking.timeSlot}*. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç–µ –æ–ø–ª–∞—Ç—É.`,
			parse_mode: "Markdown",
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É",
							callback_data: `confirm_payment;${booking._id}`,
						},
						{
							text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –æ–ø–ª–∞—Ç—É",
							callback_data: `reject_payment;${booking._id}`,
						},
					],
				],
			},
		});
	}

	// –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
	await stateController.clearState(chatId);

	bot.sendMessage(
		chatId,
		"–°–ø–∞—Å–∏–±–æ! –í–∞—à —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞."
	);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –æ—Ç–º–µ–Ω—ã
async function processCancellationScreenshot(state, photoId, chatId, user) {
	const bookingId = state.bookingInfo;
	const booking = await Booking.findById(bookingId);

	if (!booking) {
		return bot.sendMessage(
			chatId,
			"–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
		);
	}

	booking.canceledScreenshot = photoId;
	booking.status = "awaiting_cancelling_confirmation";
	await booking.save();

	const recipientId =
		user instanceof Photographer
			? booking.clientId
			: booking.photographerId;
	const recipient = await (user instanceof Photographer
		? Client
		: Photographer
	).findById(recipientId);

	if (recipient) {
		await bot.sendPhoto(recipient.telegramId, photoId, {
			caption: `–ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ã –æ—Ç ${user.firstName}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–º–µ–Ω—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ.`,
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–º–µ–Ω—É",
							callback_data: `confirm_cancelling;${booking._id}`,
						},
					],
				],
			},
		});
	}

	bot.sendMessage(
		chatId,
		"–°–ø–∞—Å–∏–±–æ! –í–∞—à —Å–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏–Ω—è—Ç. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
	);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
async function addPortfolioPhoto(state, photoId, chatId) {
	const tempPhotos = state.tempPhotos || [];
	tempPhotos.push({ file_id: photoId, title: "", category: "" });

	await stateController.setState(chatId, { ...state, tempPhotos });
	bot.sendMessage(
		chatId,
		"–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /done –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.",
		{ parse_mode: "Markdown" }
	);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
bot.onText(/\/start(?: (.+))?/, async (msg, match) => {
	const chatId = msg.chat.id;
	const inviteData = match[1]; // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å

	// –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —Å photographerId
	if (inviteData) {
		const [type, photographerId] = inviteData.split("_");

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Å—Å—ã–ª–∫–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–º
		if (type === "invite" && photographerId) {
			const photographer = await Photographer.findById(photographerId);
			if (photographer) {
				// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É
				const client = await Client.findOne({
					telegramId: chatId.toString(),
				});

				if (client) {
					client.referringPhotographerId = photographer._id;
					await client.save();
					bot.sendMessage(
						chatId,
						`–í—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É ${photographer.firstName} ${photographer.lastName}.`
					);
				} else {
					// –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
					await stateController.setState(chatId, {
						state: "registering",
						step: "get_name",
						referringPhotographerId: photographer._id, // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞
					});
					bot.sendMessage(
						chatId,
						"–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ—Å—å. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:"
					);
				}
			} else {
				bot.sendMessage(chatId, "–§–æ—Ç–æ–≥—Ä–∞—Ñ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.");
			}
		}
		return; // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —ç—Ç–æ–π —á–∞—Å—Ç–∏
	}

	// –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
	const client = await Client.findOne({ telegramId: chatId.toString() });
	const photographer = await Photographer.findOne({
		telegramId: chatId.toString(),
	});

	if (client) {
		bot.sendMessage(chatId, `–ü—Ä–∏–≤–µ—Ç, ${client.name}! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`, {
			reply_markup: {
				keyboard: [
					["üîç –ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–æ–≤"],
					["üë§ –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç", "üìÖ –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"],
					["‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã"],
				],
				one_time_keyboard: false,
				resize_keyboard: true,
			},
		});
	} else if (photographer) {
		bot.sendMessage(
			chatId,
			`–ü—Ä–∏–≤–µ—Ç, ${photographer.firstName}! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`,
			{
				reply_markup: {
					keyboard: [
						[{ text: "üì∏ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ" }],
						[{ text: "üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è" }, { text: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏" }],
						[{ text: "üïí –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏" }],
						[{ text: "üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã" }, { text: "üéü –°—Å—ã–ª–∫–∞" }],
						[{ text: "üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤" }], // –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
					],
					resize_keyboard: true,
					one_time_keyboard: false,
				},
			}
		);
	} else {
		// –ï—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
		await stateController.setState(chatId, {
			state: "registering",
			step: "get_name",
		});
		bot.sendMessage(
			chatId,
			"–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ—Å—å. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:"
		);
	}
});
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /done
bot.onText(/\/done/, async (msg) => {
	const chatId = msg.chat.id;
	const state = await stateController.getState(chatId);

	if (state && state.state === "awaiting_portfolio_photos") {
		await photographerController.chooseNamingPortfolioPhotos(
			bot,
			chatId,
			"/done",
			state
		);
	} else {
		bot.sendMessage(
			chatId,
			"–í—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π."
		);
	}
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback_query
bot.on("callback_query", (query) => {
	callbackHandler.handleCallbackQuery(bot, query);
});

module.exports = { bot, calendar };
